<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Teoria da Usinagem — Plataforma Integral (TOC Estruturado)</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Lora:ital,wght@0,400;0,600&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Inter', sans-serif; background:#f8fafc; color:#334155; }
    .serif { font-family: 'Lora', serif; }
    .app-grid { display:grid; grid-template-columns:320px 1fr; height:100vh; overflow:hidden; }
    .sidebar { background:#fff; border-right:1px solid #e6e9ee; display:flex; flex-direction:column; }
    .toc-item { cursor:pointer; user-select:none; }
    .collapse { display:none; }
    .toc-scroll { overflow:auto; padding:0.5rem 0.75rem; }
    .content-body h1 { font-size:2.25rem; }
    .content-body p { line-height:1.8; }
    @media (max-width:820px) { .app-grid { grid-template-columns: 1fr; } .sidebar { display:none; } .sidebar.open { display:flex; position:absolute; z-index:50; width:100%; height:100%; } }
    .small-muted { font-size:12px; color:#6b7280; }
  </style>
</head>
<body>
  <div class="app-grid">

    <!-- SIDEBAR -->
    <aside id="sidebar" class="sidebar">
      <div class="p-4 border-b bg-slate-900 text-white">
        <h2 class="serif font-bold text-lg">Teoria da Usinagem</h2>
        <div class="text-xs opacity-70 mt-1">Estrutura completa (mapa do livro)</div>
      </div>

      <div class="p-3 border-b">
        <div class="relative">
          <i class="fas fa-search absolute left-3 top-3 text-slate-400 text-xs"></i>
          <input id="search-input" onkeyup="app.search()" placeholder="Buscar..." class="pl-8 pr-3 py-2 w-full rounded border bg-slate-50 text-sm" />
        </div>
      </div>

      <div class="flex-1 toc-scroll" id="toc-root">
        <!-- TOC injected by JS -->
      </div>

      <div class="p-3 border-t bg-slate-50">
        <div class="flex gap-2">
          <label class="flex-1 cursor-pointer bg-white border rounded p-2 text-xs text-slate-700 text-center">
            <input id="file-input" type="file" accept="application/json,application/pdf" style="display:none" onchange="app.handleFile(this.files)" />
            <i class="fas fa-file-import mr-2"></i> Importar chapters.json / PDF
          </label>
          <button onclick="app.toggleSidebarMobile()" class="px-3 py-2 border rounded text-xs"><i class="fas fa-bars"></i></button>
        </div>
        <div class="mt-2 text-xs small-muted">Sugestão: gere chapters.json com OCR (recomendo GitHub Action ou rodar localmente).</div>
      </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex flex-col bg-white">
      <header class="md:hidden flex items-center justify-between p-3 border-b">
        <div class="font-bold">Teoria da Usinagem</div>
        <button onclick="app.toggleSidebarMobile()" class="text-slate-600"><i class="fas fa-bars"></i></button>
      </header>

      <div id="toolbar" class="flex items-center justify-between p-4 border-b">
        <div id="breadcrumbs" class="text-sm text-slate-500">Início</div>
        <div class="flex items-center gap-2">
          <button onclick="app.adjustFontSize(-1)" class="px-2 py-1 border rounded">A-</button>
          <button onclick="app.adjustFontSize(1)" class="px-2 py-1 border rounded">A+</button>
        </div>
      </div>

      <div id="content-area" class="flex-1 overflow-auto p-8">
        <!-- Home content -->
        <div id="home" class="max-w-4xl mx-auto text-center">
          <i class="fas fa-book-reader text-6xl text-blue-200 mb-4"></i>
          <h1 class="serif text-4xl font-bold text-slate-900 mb-3">Plataforma de Estudo Integral</h1>
          <p class="text-slate-600 mb-6">A estrutura completa do livro foi carregada no TOC lateral. Clique em qualquer item para visualizar o conteúdo (se disponível) ou importe um <strong>chapters.json</strong> para preencher todo o conteúdo automaticamente.</p>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="p-4 bg-white border rounded">
              <h3 class="font-bold">Abrir PDF / Importar JSON</h3>
              <p class="small-muted mt-2">Clique em "Importar chapters.json / PDF" na barra lateral para carregar o conteúdo.</p>
            </div>
            <div class="p-4 bg-white border rounded">
              <h3 class="font-bold">Tutor & Simulado</h3>
              <p class="small-muted mt-2">Use o tutor para perguntar sobre o conteúdo e o simulado para testar seu conhecimento.</p>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    // --- 1. Estrutura solicitada (TOC) baseada no mind-map enviado
    const tocStructure = [
      { id: "ch1", title: "1. Introdução e a Teoria da Usinagem", children: [
        { id:"ch1.1", title:"1.1 Princípios gerais de usinagem" },
        { id:"ch1.2", title:"1.2 Grandezas físicas no processo de corte" }
      ]},
      { id: "ch2", title: "2. Geometria da Ferramenta de Corte", children: [
        { id:"ch2.1", title:"2.1 Definições" },
        { id:"ch2.2", title:"2.2 Sistema de referência" },
        { id:"ch2.3", title:"2.3 Funções e influência de principais ângulos" },
        { id:"ch2.4", title:"2.4 Outros atributos da cunha cortante" }
      ]},
      { id: "ch3", title: "3. Formação do Cavaco", children: [
        { id:"ch3.1", title:"3.1 Mecanismo de formação" },
        { id:"ch3.2", title:"3.2 Tipos de cavaco" },
        { id:"ch3.3", title:"3.3 Aresta postiça de corte (BUE)" }
      ]},
      { id: "ch4", title: "4. Forças e Potencial de Usinagem", children: [
        { id:"ch4.1", title:"4.1 Decomposição vetorial das forças" },
        { id:"ch4.2", title:"4.2 Equações empíricas (Kienzle etc.)" },
        { id:"ch4.3", title:"4.3 Potência e energia de corte" },
        { id:"ch4.4", title:"4.4 Faixa de trabalho e limites" }
      ]},
      { id: "ch5", title: "5. Temperatura no Processo de Usinagem", children: [
        { id:"ch5.1", title:"5.1 Geração de calor" },
        { id:"ch5.2", title:"5.2 Distribuição do calor" },
        { id:"ch5.3", title:"5.3 Medição e controle de temperatura" }
      ]},
      { id: "ch6", title: "6. Fluidos de Corte", children: [
        { id:"ch6.1", title:"6.1 Funções dos fluidos" },
        { id:"ch6.2", title:"6.2 Tipos: óleos, emulsões, MQL, sintéticos" },
        { id:"ch6.3", title:"6.3 Métodos de aplicação" }
      ]},
      { id: "ch7", title: "7. Materiais para Ferramentas de Corte", children: [
        { id:"ch7.1", title:"7.1 Aço rápido (HSS)" },
        { id:"ch7.2", title:"7.2 Metal duro (carbonetos)" },
        { id:"ch7.3", title:"7.3 Cerâmicas" },
        { id:"ch7.4", title:"7.4 Superduros (CBN/PCD)" },
        { id:"ch7.5", title:"7.5 Revestimentos e tratamentos" }
      ]},
      { id: "ch8", title: "8. Vida da Ferramenta — Desgaste e Falhas", children: [
        { id:"ch8.1", title:"8.1 Mecanismos de desgaste: adesão, abrasão, difusão" },
        { id:"ch8.2", title:"8.2 Critérios de fim de vida (VB, cratera)" },
        { id:"ch8.3", title:"8.3 Equação de Taylor e otimização" }
      ]},
      { id: "ch9", title: "9. Integridade Superficial", children: [
        { id:"ch9.1", title:"9.1 Rugosidade vs. integridade" },
        { id:"ch9.2", title:"9.2 Tensões residuais e alterações microestruturais" },
        { id:"ch9.3", title:"9.3 Ensaios e medição" }
      ]},
      { id: "ch10", title: "10. Condições Econômicas de Corte", children: [
        { id:"ch10.1", title:"10.1 Cálculo de velocidade ótima" },
        { id:"ch10.2", title:"10.2 Custo por peça e trade-offs" },
        { id:"ch10.3", title:"10.3 Intervalos de eficiência" }
      ]},
      { id: "ch11", title: "11. Usinagem por Abrasão", children: [
        { id:"ch11.1", title:"11.1 Processos e ferramentas abrasivas" },
        { id:"ch11.2", title:"11.2 Materiais e aplicações" },
        { id:"ch11.3", title:"11.3 Controle de processo" }
      ]},
      { id: "ch12", title: "12. Aspectos Tecnológicos e Recomendações", children: [
        { id:"ch12.1", title:"12.1 Aços e ligas" },
        { id:"ch12.2", title:"12.2 Fixação e parâmetros de usinagem" },
        { id:"ch12.3", title:"12.3 Recomendações práticas" }
      ]}
    ];

    // --- 2. db: conteúdo (inicial vazio). Você pode importar chapters.json para preencher.
    let db = { chapters: [], quiz: [] };

    // --- 3. Renders
    const tocRoot = document.getElementById('toc-root');
    function buildTOC(struct) {
      tocRoot.innerHTML = '';
      struct.forEach(node => {
        const nodeEl = document.createElement('div');
        nodeEl.className = 'mb-1';
        const head = document.createElement('div');
        head.className = 'flex items-center justify-between p-2 rounded hover:bg-slate-50 toc-item';
        head.innerHTML = `<div class="flex items-center gap-2"><i class="fas fa-chevron-right text-xs mr-1"></i><div><strong>${node.title}</strong></div></div>`;
        head.onclick = () => toggleNode(node.id);
        nodeEl.appendChild(head);

        const childrenWrap = document.createElement('div');
        childrenWrap.className = 'ml-4 mt-2 collapse';
        childrenWrap.id = `wrap-${node.id}`;

        if (node.children && node.children.length) {
          node.children.forEach(child => {
            const c = document.createElement('div');
            c.className = 'p-1 rounded hover:bg-slate-50 text-sm';
            c.innerHTML = `<span class="text-slate-700">${child.title}</span>`;
            c.onclick = (ev) => { ev.stopPropagation(); onTocClick(child); };
            childrenWrap.appendChild(c);
          });
        }

        nodeEl.appendChild(childrenWrap);
        tocRoot.appendChild(nodeEl);
      });
    }

    function toggleNode(id) {
      const wrap = document.getElementById('wrap-' + id);
      if(!wrap) return;
      const icon = wrap.previousSibling.querySelector('i.fas');
      if (wrap.classList.contains('collapse')) { wrap.classList.remove('collapse'); if(icon) icon.className='fas fa-chevron-down text-xs mr-1'; }
      else { wrap.classList.add('collapse'); if(icon) icon.className='fas fa-chevron-right text-xs mr-1'; }
    }

    // when toc child clicked: try to load content from db.chapters by matching title approx
    function onTocClick(node) {
      const title = node.title;
      // search in db.chapters - match by startsWith number or by subtitle
      const found = db.chapters.find(c => (c.title && title.replace(/^\d+\.\s*/,'').toLowerCase().includes(c.title.replace(/^\d+\.\s*/,'').toLowerCase())) || c.id === node.id);
      // better: try to match by id if chapters have id same as toc (we will try multiple heuristics)
      let chapter = null;
      if(!found) {
        chapter = db.chapters.find(ch => ch.title && ch.title.toLowerCase().includes(title.toLowerCase()));
      } else chapter = found;
      renderContent(node.title, chapter);
    }

    function renderContent(displayTitle, chapter=null) {
      const area = document.getElementById('content-area');
      document.getElementById('breadcrumbs').innerText = `Início / ${displayTitle}`;
      if(!chapter) {
        area.innerHTML = `<div class="max-w-4xl mx-auto"><h1 class="serif text-3xl font-bold mb-4">${displayTitle}</h1>
          <p class="text-slate-600">Conteúdo ainda não disponível localmente para este tópico. Importe um <code>chapters.json</code> (que contenha o texto do livro) ou gere via OCR. Depois poderá visualizar o texto aqui.</p>
          <div class="mt-6"><button onclick="document.getElementById('file-input').click()" class="px-4 py-2 bg-blue-600 text-white rounded">Importar chapters.json</button></div></div>`;
        return;
      }

      // If chapter exists, show its sections
      const sectionsHtml = (chapter.sections || []).map(s => `<h3 class="text-xl font-semibold mt-4">${s.subtitle}</h3><p class="mt-2 text-slate-700">${s.text || '<em>(vazio)</em>'}</p>`).join('');
      area.innerHTML = `<div class="max-w-4xl mx-auto content-body" style="font-size:16px"><h1 class="serif text-3xl font-bold">${chapter.title}</h1><div class="h-1 w-24 bg-blue-600 my-4"></div>${sectionsHtml}</div>`;
    }

    // search over db.chapters and toc titles
    window.app = {
      init() {
        buildTOC(tocStructure);
        // load fallback chapters.json if present at /generated/chapters.json
        fetch('generated/chapters.json').then(r => {
          if(r.ok) return r.json();
          throw new Error('no');
        }).then(json => {
          db.chapters = json.chapters || [];
          console.log('Loaded generated/chapters.json -> chapters:', db.chapters.length);
        }).catch(()=>{/* ignore */});
      },

      adjustFontSize(d) {
        const body = document.querySelector('.content-body');
        if(body) {
          const size = parseInt(window.getComputedStyle(body).fontSize) + d;
          body.style.fontSize = size + 'px';
        }
      },

      toggleSidebarMobile() {
        const s = document.getElementById('sidebar');
        s.classList.toggle('open');
      },

      handleFile(files) {
        if(!files || files.length===0) return;
        const f = files[0];
        const ext = f.name.split('.').pop().toLowerCase();
        if(ext === 'json') {
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const json = JSON.parse(e.target.result);
              if(json.chapters && Array.isArray(json.chapters)) {
                db.chapters = json.chapters;
                alert('chapters.json importado com ' + db.chapters.length + ' capítulos.');
              } else {
                alert('JSON carregado não tem a chave chapters[]. Verifique o formato.');
              }
            } catch(err) {
              alert('JSON inválido: ' + err.message);
            }
          };
          reader.readAsText(f, 'utf-8');
        } else if (ext === 'pdf') {
          alert('PDF importado. Para extrair texto automático, use o workflow de OCR (recomendado) ou exporte chapters.json localmente e importe aqui.');
          // create URL to preview if desired
          const url = URL.createObjectURL(f);
          window.open(url, '_blank');
        } else {
          alert('Formato não suportado. Envie chapters.json ou PDF.');
        }
      },

      search() {
        const q = document.getElementById('search-input').value.trim().toLowerCase();
        if(!q) { buildTOC(tocStructure); return; }
        // search in toc titles first, then chapters contents
        const results = [];
        tocStructure.forEach(node => {
          if(node.title.toLowerCase().includes(q)) results.push({title:node.title, node});
          node.children && node.children.forEach(child => {
            if(child.title.toLowerCase().includes(q)) results.push({title:child.title, node:child});
          });
        });
        // also search inside db.chapters text
        db.chapters.forEach(ch => {
          if((ch.title && ch.title.toLowerCase().includes(q)) || (ch.sections && ch.sections.some(s => s.text && s.text.toLowerCase().includes(q)))) {
            results.push({title: ch.title || ch.id, node: { title: ch.title || ch.id, isChapter: true, id: ch.id }});
          }
        });

        // render search results in tocRoot
        tocRoot.innerHTML = '';
        if(results.length === 0) {
          tocRoot.innerHTML = '<div class="p-3 text-xs text-slate-400">Nenhum resultado.</div>';
          return;
        }
        results.forEach(r => {
          const el = document.createElement('div');
          el.className = 'p-2 hover:bg-slate-50 rounded text-sm';
          el.innerHTML = `<strong>${r.title}</strong>`;
          el.onclick = () => {
            if(r.node.isChapter) renderContent(r.title, db.chapters.find(c => (c.title||'') === r.title));
            else onTocClick(r.node);
          };
          tocRoot.appendChild(el);
        });
      }

    };

    window.addEventListener('load', () => app.init());
  </script>
</body>
</html>
